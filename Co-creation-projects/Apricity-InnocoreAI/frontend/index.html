<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç ”åˆ›Â·æ™ºæ ¸ - InnoCore AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 40px 0;
            color: white;
        }

        header h1 {
            font-size: 3rem;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        header p {
            font-size: 1.2rem;
            opacity: 0.9;
        }

        .main-content {
            background: white;
            border-radius: 15px;
            padding: 40px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 30px;
        }

        .features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }

        .feature-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }

        .feature-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.1);
        }

        .feature-card.active {
            background: #e8f0fe;
            border-left-color: #4285f4;
        }

        .feature-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.3rem;
        }

        .feature-card p {
            color: #666;
            line-height: 1.6;
            margin-bottom: 15px;
        }

        .btn {
            background: #667eea;
            color: white;
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: background 0.3s ease;
        }

        .btn:hover {
            background: #5a6fd8;
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }

        .interaction-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 30px;
            margin-top: 30px;
            display: none;
        }

        .interaction-panel.active {
            display: block;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }

        .input-group input,
        .input-group textarea,
        .input-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus,
        .input-group textarea:focus,
        .input-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group textarea {
            min-height: 120px;
            resize: vertical;
        }

        .response-area {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Consolas', 'Monaco', monospace;
        }

        .response-area pre {
            background: white;
            padding: 15px;
            border-radius: 6px;
            border-left: 4px solid #667eea;
            overflow-x: auto;
            margin: 10px 0;
            font-size: 0.9rem;
            line-height: 1.6;
        }

        .paper-card {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin: 15px 0;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .paper-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .paper-card h4 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 1.1rem;
            line-height: 1.4;
        }

        .paper-card .authors {
            color: #666;
            font-size: 0.9rem;
            margin: 8px 0;
        }

        .paper-card .abstract {
            color: #444;
            line-height: 1.6;
            margin: 12px 0;
            font-size: 0.95rem;
        }

        .paper-card .meta {
            display: flex;
            gap: 15px;
            margin-top: 12px;
            font-size: 0.85rem;
            color: #888;
        }

        .paper-card .meta span {
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }

        .paper-card a {
            color: #667eea;
            text-decoration: none;
            font-weight: 500;
        }

        .paper-card a:hover {
            text-decoration: underline;
        }

        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin: -20px -20px 20px -20px;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-stats {
            background: rgba(255, 255, 255, 0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #667eea;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        .error {
            background: #ffebee;
            border: 1px solid #f44336;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .success {
            background: #e8f5e8;
            border: 1px solid #4caf50;
            color: #2e7d32;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .nav-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin: 30px 0;
            flex-wrap: wrap;
        }

        .nav-buttons .btn {
            padding: 12px 25px;
            font-size: 1rem;
            text-decoration: none;
            display: inline-block;
        }

        .file-upload {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .file-upload:hover {
            background: #f8f9ff;
        }

        .file-upload.dragover {
            background: #e8f0fe;
            border-color: #4285f4;
        }

        .copy-btn {
            float: right;
            background: rgba(102, 126, 234, 0.1);
            border: 1px solid #667eea;
            color: #667eea;
            padding: 5px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .copy-btn:hover {
            background: #667eea;
            color: white;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #999;
            font-size: 1.1rem;
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .badge-success {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .badge-info {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-warning {
            background: #fff3e0;
            color: #f57c00;
        }

        .json-key {
            color: #0066cc;
            font-weight: 600;
        }

        .json-string {
            color: #008000;
        }

        .json-number {
            color: #ff6600;
        }

        .json-boolean {
            color: #cc00cc;
            font-weight: 600;
        }

        .json-null {
            color: #999;
            font-style: italic;
        }

        .markdown-content {
            line-height: 1.8;
            color: #333;
        }

        .markdown-content h1,
        .markdown-content h2,
        .markdown-content h3 {
            color: #667eea;
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .markdown-content ul {
            list-style-type: disc;
            padding-left: 25px;
            margin: 15px 0;
        }

        .markdown-content li {
            margin: 10px 0;
            line-height: 1.8;
        }

        .markdown-content strong {
            color: #333;
            font-weight: 600;
        }

        .markdown-content code {
            background: #f0f0f0;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Consolas', 'Monaco', monospace;
            color: #e83e8c;
            font-size: 0.9em;
        }

        .markdown-content pre {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            border-left: 4px solid #667eea;
            margin: 15px 0;
        }

        .markdown-content pre code {
            background: none;
            padding: 0;
            color: #333;
        }

        .markdown-content a {
            color: #667eea;
            text-decoration: none;
            border-bottom: 1px solid #667eea;
        }

        .markdown-content a:hover {
            color: #5a6fd8;
            border-bottom-color: #5a6fd8;
        }

        .markdown-content p {
            margin: 12px 0;
            line-height: 1.8;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ§  ç ”åˆ›Â·æ™ºæ ¸</h1>
            <p>åŸºäºå¤šæ™ºèƒ½ä½“æ¶æ„çš„æ™ºèƒ½ç§‘ç ”åŠ©æ‰‹å¹³å°</p>
        </header>

        <main class="main-content">
            <div class="status" id="systemStatus">
                âœ… ç³»ç»Ÿåˆå§‹åŒ–ä¸­...
            </div>

            <div class="nav-buttons">
                <a href="/docs" class="btn" target="_blank">ğŸ“š API æ–‡æ¡£</a>
                <a href="/health" class="btn" target="_blank">ğŸ” å¥åº·æ£€æŸ¥</a>
                <button class="btn" onclick="checkSystemStatus()">ğŸ”„ åˆ·æ–°çŠ¶æ€</button>
            </div>

            <section>
                <h2>ğŸš€ æ ¸å¿ƒåŠŸèƒ½</h2>

                <!-- å·¥ä½œæµæ¨¡å¼é€‰æ‹© -->
                <div
                    style="margin-bottom: 20px; padding: 15px; background: #f0f7ff; border-radius: 8px; border-left: 4px solid #667eea;">
                    <h3 style="margin: 0 0 10px 0; color: #667eea;">ğŸ”„ å·¥ä½œæ¨¡å¼</h3>
                    <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="work-mode" value="individual" checked style="margin-right: 8px;">
                            <span>å•ç‹¬æ¨¡å¼ - ç‹¬ç«‹ä½¿ç”¨æ¯ä¸ªæ™ºèƒ½ä½“</span>
                        </label>
                        <label style="display: flex; align-items: center; cursor: pointer;">
                            <input type="radio" name="work-mode" value="workflow" style="margin-right: 8px;">
                            <span>åè°ƒæ¨¡å¼ - è‡ªåŠ¨åŒ–å®Œæ•´å·¥ä½œæµ â­</span>
                        </label>
                    </div>
                </div>

                <div class="features">
                    <div class="feature-card" onclick="activateAgent('workflow')" id="workflow-card"
                        style="display: none; grid-column: 1 / -1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <h3>ğŸ”„ å®Œæ•´å·¥ä½œæµ</h3>
                        <p>è‡ªåŠ¨åè°ƒæ‰€æœ‰æ™ºèƒ½ä½“ï¼šæœç´¢è®ºæ–‡ â†’ æ·±åº¦åˆ†æ â†’ ç”Ÿæˆå¼•ç”¨ â†’ æ’°å†™æŠ¥å‘Š</p>
                        <button class="btn" style="background: white; color: #667eea;"
                            onclick="event.stopPropagation(); activateAgent('workflow')">å¯åŠ¨å·¥ä½œæµ</button>
                    </div>

                    <div class="feature-card" onclick="activateAgent('hunter')" id="hunter-card">
                        <h3>ğŸ•µï¸ Hunter Agent</h3>
                        <p>æ™ºèƒ½æ–‡çŒ®æœç´¢ä¸ç›‘æ§ï¼Œè‡ªåŠ¨æŠ“å– ArXivã€IEEE ç­‰å¹³å°çš„æœ€æ–°è®ºæ–‡</p>
                        <button class="btn" onclick="event.stopPropagation(); activateAgent('hunter')">å¼€å§‹æœç´¢</button>
                    </div>

                    <div class="feature-card" onclick="activateAgent('miner')" id="miner-card">
                        <h3>ğŸ§  Miner Agent</h3>
                        <p>æ·±åº¦è®ºæ–‡åˆ†æï¼ŒæŒ–æ˜åˆ›æ–°ç‚¹ï¼Œç”Ÿæˆç»“æ„åŒ–ç ”ç©¶æŠ¥å‘Š</p>
                        <button class="btn" onclick="event.stopPropagation(); activateAgent('miner')">åˆ†æè®ºæ–‡</button>
                    </div>

                    <div class="feature-card" onclick="activateAgent('coach')" id="coach-card">
                        <h3>âœï¸ Coach Agent</h3>
                        <p>ä¸ªæ€§åŒ–å†™ä½œåŠ©æ‰‹ï¼Œæä¾›å­¦æœ¯æ¶¦è‰²ã€é£æ ¼è¿ç§»å’Œå®æ—¶æŒ‡å¯¼</p>
                        <button class="btn" onclick="event.stopPropagation(); activateAgent('coach')">å†™ä½œåŠ©æ‰‹</button>
                    </div>

                    <div class="feature-card" onclick="activateAgent('validator')" id="validator-card">
                        <h3>ğŸ” Validator Agent</h3>
                        <p>å¼•ç”¨æ ¼å¼æ ¡éªŒï¼Œç¡®ä¿å­¦æœ¯å¼•ç”¨çš„å‡†ç¡®æ€§å’Œæ ‡å‡†åŒ–</p>
                        <button class="btn" onclick="event.stopPropagation(); activateAgent('validator')">æ ¡éªŒå¼•ç”¨</button>
                    </div>
                </div>
            </section>

            <!-- Hunter Agent äº¤äº’é¢æ¿ -->
            <div class="interaction-panel" id="hunter-panel">
                <h3>ğŸ•µï¸ æ–‡çŒ®æœç´¢</h3>
                <div class="input-group">
                    <label for="search-keywords">æœç´¢å…³é”®è¯</label>
                    <input type="text" id="search-keywords"
                        placeholder="ä¾‹å¦‚: machine learning, natural language processing">
                </div>
                <div class="input-group">
                    <label for="search-source">æœç´¢æ¥æº</label>
                    <select id="search-source">
                        <option value="arxiv">ArXiv</option>
                        <option value="ieee">IEEE</option>
                        <option value="pubmed">PubMed</option>
                        <option value="all">å…¨éƒ¨æ¥æº</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="search-limit">è®ºæ–‡æ•°é‡é™åˆ¶</label>
                    <input type="number" id="search-limit" value="10" min="1" max="50">
                </div>
                <button class="btn" onclick="executeHunterTask()">å¼€å§‹æœç´¢</button>
                <div class="loading" id="hunter-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æœç´¢è®ºæ–‡...</p>
                </div>
                <div class="response-area" id="hunter-response"></div>
            </div>

            <!-- Miner Agent äº¤äº’é¢æ¿ -->
            <div class="interaction-panel" id="miner-panel">
                <h3>ğŸ§  è®ºæ–‡åˆ†æ</h3>
                <div class="input-group">
                    <label for="paper-upload">ä¸Šä¼ è®ºæ–‡ (PDF)</label>
                    <div class="file-upload" id="paper-upload-area">
                        <p>ğŸ“„ ç‚¹å‡»æˆ–æ‹–æ‹½PDFæ–‡ä»¶åˆ°æ­¤å¤„</p>
                        <input type="file" id="paper-file" accept=".pdf" style="display: none;">
                    </div>
                </div>
                <div class="input-group">
                    <label for="paper-url">æˆ–è¾“å…¥è®ºæ–‡URL</label>
                    <input type="url" id="paper-url" placeholder="https://arxiv.org/abs/...">
                </div>
                <div class="input-group">
                    <label for="analysis-type">åˆ†æç±»å‹</label>
                    <select id="analysis-type">
                        <option value="summary">å†…å®¹æ‘˜è¦</option>
                        <option value="innovation">åˆ›æ–°ç‚¹åˆ†æ</option>
                        <option value="comparison">å¯¹æ¯”åˆ†æ</option>
                        <option value="comprehensive">ç»¼åˆåˆ†æ</option>
                    </select>
                </div>
                <button class="btn" onclick="executeMinerTask()">å¼€å§‹åˆ†æ</button>
                <div class="loading" id="miner-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨åˆ†æè®ºæ–‡...</p>
                </div>
                <div class="response-area" id="miner-response"></div>
            </div>

            <!-- Coach Agent äº¤äº’é¢æ¿ -->
            <div class="interaction-panel" id="coach-panel">
                <h3>âœï¸ å†™ä½œåŠ©æ‰‹</h3>
                <div class="input-group">
                    <label for="writing-text">æ‚¨çš„æ–‡æœ¬</label>
                    <textarea id="writing-text" placeholder="è¯·è¾“å…¥éœ€è¦æ¶¦è‰²çš„å­¦æœ¯æ–‡æœ¬..."></textarea>
                </div>
                <div class="input-group">
                    <label for="writing-style">å†™ä½œé£æ ¼</label>
                    <select id="writing-style">
                        <option value="formal">æ­£å¼å­¦æœ¯é£æ ¼</option>
                        <option value="nature">Natureé£æ ¼</option>
                        <option value="science">Scienceé£æ ¼</option>
                        <option value="ieee">IEEEé£æ ¼</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="writing-task">ä»»åŠ¡ç±»å‹</label>
                    <select id="writing-task">
                        <option value="polish">æ¶¦è‰²æ”¹è¿›</option>
                        <option value="translate">ä¸­è¯‘è‹±</option>
                        <option value="explain">è§£é‡Šæ¦‚å¿µ</option>
                        <option value="expand">å†…å®¹æ‰©å±•</option>
                    </select>
                </div>
                <button class="btn" onclick="executeCoachTask()">å¼€å§‹å¤„ç†</button>
                <div class="loading" id="coach-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨å¤„ç†æ–‡æœ¬...</p>
                </div>
                <div class="response-area" id="coach-response"></div>
            </div>

            <!-- Validator Agent äº¤äº’é¢æ¿ -->
            <div class="interaction-panel" id="validator-panel">
                <h3>ğŸ” å¼•ç”¨æ ¡éªŒ</h3>
                <div class="input-group">
                    <label for="citation-input">å¼•ç”¨ä¿¡æ¯</label>
                    <textarea id="citation-input" placeholder="è¯·è¾“å…¥å¼•ç”¨ä¿¡æ¯ï¼Œå¯ä»¥æ˜¯DOIã€æ ‡é¢˜ã€æˆ–BibTeXæ ¼å¼..."></textarea>
                </div>
                <div class="input-group">
                    <label for="citation-format">è¾“å‡ºæ ¼å¼</label>
                    <select id="citation-format">
                        <option value="bibtex">BibTeX</option>
                        <option value="apa">APA</option>
                        <option value="ieee">IEEE</option>
                        <option value="mla">MLA</option>
                    </select>
                </div>
                <button class="btn" onclick="executeValidatorTask()">æ ¡éªŒå¼•ç”¨</button>
                <div class="loading" id="validator-loading">
                    <div class="spinner"></div>
                    <p>æ­£åœ¨æ ¡éªŒå¼•ç”¨...</p>
                </div>
                <div class="response-area" id="validator-response"></div>
            </div>

            <!-- Workflow åè°ƒé¢æ¿ -->
            <div class="interaction-panel" id="workflow-panel">
                <h3>ğŸ”„ å®Œæ•´å·¥ä½œæµ</h3>
                <p style="color: #666; margin-bottom: 20px;">è‡ªåŠ¨åè°ƒæ‰€æœ‰æ™ºèƒ½ä½“å®Œæˆå®Œæ•´çš„ç ”ç©¶æµç¨‹</p>

                <div class="input-group">
                    <label for="workflow-keywords">ç ”ç©¶å…³é”®è¯</label>
                    <input type="text" id="workflow-keywords" placeholder="ä¾‹å¦‚: deep learning for computer vision">
                </div>

                <div class="input-group">
                    <label for="workflow-limit">æœç´¢è®ºæ–‡æ•°é‡</label>
                    <select id="workflow-limit">
                        <option value="3">3ç¯‡ï¼ˆå¿«é€Ÿï¼‰</option>
                        <option value="5" selected>5ç¯‡ï¼ˆæ¨èï¼‰</option>
                        <option value="10">10ç¯‡ï¼ˆè¯¦ç»†ï¼‰</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="workflow-analysis-type">åˆ†æç±»å‹</label>
                    <select id="workflow-analysis-type">
                        <option value="summary">æ‘˜è¦åˆ†æ</option>
                        <option value="innovation">åˆ›æ–°ç‚¹åˆ†æ</option>
                        <option value="comparison">å¯¹æ¯”åˆ†æ</option>
                        <option value="comprehensive">ç»¼åˆåˆ†æ</option>
                    </select>
                </div>

                <div class="input-group">
                    <label for="workflow-citation-format">å¼•ç”¨æ ¼å¼</label>
                    <select id="workflow-citation-format">
                        <option value="bibtex">BibTeX</option>
                        <option value="apa">APA</option>
                        <option value="ieee">IEEE</option>
                        <option value="mla">MLA</option>
                    </select>
                </div>

                <div class="input-group">
                    <label>
                        <input type="checkbox" id="workflow-generate-report" checked>
                        ç”Ÿæˆç»¼åˆæŠ¥å‘Š
                    </label>
                </div>

                <button class="btn" onclick="executeWorkflow()"
                    style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">ğŸš€ å¯åŠ¨å®Œæ•´å·¥ä½œæµ</button>

                <div class="loading" id="workflow-loading">
                    <div class="spinner"></div>
                    <p>å·¥ä½œæµæ‰§è¡Œä¸­ï¼Œè¯·ç¨å€™...</p>
                </div>

                <div class="response-area" id="workflow-response"></div>
            </div>
        </main>
    </div>

    <script>
        let currentAgent = null;

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        document.addEventListener('DOMContentLoaded', function () {
            checkSystemStatus();
            setupFileUpload();
            setupWorkModeSwitch();
        });

        // è®¾ç½®å·¥ä½œæ¨¡å¼åˆ‡æ¢
        function setupWorkModeSwitch() {
            const modeRadios = document.querySelectorAll('input[name="work-mode"]');
            modeRadios.forEach(radio => {
                radio.addEventListener('change', function () {
                    const workflowCard = document.getElementById('workflow-card');
                    if (this.value === 'workflow') {
                        workflowCard.style.display = 'block';
                    } else {
                        workflowCard.style.display = 'none';
                    }
                });
            });
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            try {
                const response = await fetch('/health');
                const data = await response.json();

                if (response.ok) {
                    statusDiv.className = 'status';
                    statusDiv.innerHTML = `âœ… ç³»ç»Ÿè¿è¡Œæ­£å¸¸ | çŠ¶æ€: ${data.status} | æ—¶é—´: ${new Date().toLocaleString()}`;
                } else {
                    throw new Error('ç³»ç»ŸçŠ¶æ€å¼‚å¸¸');
                }
            } catch (error) {
                statusDiv.className = 'error';
                statusDiv.innerHTML = `âŒ ç³»ç»Ÿè¿æ¥å¤±è´¥: ${error.message}`;
            }
        }

        // æ¿€æ´»æ™ºèƒ½ä½“
        function activateAgent(agentType) {
            // é‡ç½®æ‰€æœ‰å¡ç‰‡å’Œé¢æ¿
            document.querySelectorAll('.feature-card').forEach(card => {
                card.classList.remove('active');
            });
            document.querySelectorAll('.interaction-panel').forEach(panel => {
                panel.classList.remove('active');
            });

            // æ¿€æ´»é€‰ä¸­çš„æ™ºèƒ½ä½“
            currentAgent = agentType;
            document.getElementById(`${agentType}-card`).classList.add('active');
            document.getElementById(`${agentType}-panel`).classList.add('active');
        }

        // æ‰§è¡ŒHunterä»»åŠ¡
        async function executeHunterTask() {
            const keywords = document.getElementById('search-keywords').value;
            const source = document.getElementById('search-source').value;
            const limit = document.getElementById('search-limit').value;

            if (!keywords.trim()) {
                showError('hunter-response', 'è¯·è¾“å…¥æœç´¢å…³é”®è¯');
                return;
            }

            showLoading('hunter-loading');

            try {
                const response = await fetch('/api/v1/papers/search', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        source: source,
                        limit: parseInt(limit)
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('hunter-response', `æ‰¾åˆ° ${data.papers?.length || 0} ç¯‡ç›¸å…³è®ºæ–‡`, data);
                } else {
                    showError('hunter-response', data.detail || 'æœç´¢å¤±è´¥');
                }
            } catch (error) {
                showError('hunter-response', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                hideLoading('hunter-loading');
            }
        }

        // æ‰§è¡ŒMinerä»»åŠ¡
        async function executeMinerTask() {
            const paperUrl = document.getElementById('paper-url').value;
            const analysisType = document.getElementById('analysis-type').value;

            if (!paperUrl.trim()) {
                showError('miner-response', 'è¯·è¾“å…¥è®ºæ–‡URLæˆ–ä¸Šä¼ PDFæ–‡ä»¶');
                return;
            }

            showLoading('miner-loading');

            try {
                const response = await fetch('/api/v1/analysis/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        paper_url: paperUrl,
                        analysis_type: analysisType
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('miner-response', 'è®ºæ–‡åˆ†æå®Œæˆ', data);
                } else {
                    showError('miner-response', data.detail || 'åˆ†æå¤±è´¥');
                }
            } catch (error) {
                showError('miner-response', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                hideLoading('miner-loading');
            }
        }

        // æ‰§è¡ŒCoachä»»åŠ¡
        async function executeCoachTask() {
            const text = document.getElementById('writing-text').value;
            const style = document.getElementById('writing-style').value;
            const task = document.getElementById('writing-task').value;

            if (!text.trim()) {
                showError('coach-response', 'è¯·è¾“å…¥éœ€è¦å¤„ç†çš„æ–‡æœ¬');
                return;
            }

            showLoading('coach-loading');

            try {
                const response = await fetch('/api/v1/writing/coach', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        text: text,
                        style: style,
                        task: task
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('coach-response', 'æ–‡æœ¬å¤„ç†å®Œæˆ', data);
                } else {
                    showError('coach-response', data.detail || 'å¤„ç†å¤±è´¥');
                }
            } catch (error) {
                showError('coach-response', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                hideLoading('coach-loading');
            }
        }

        // æ‰§è¡ŒValidatorä»»åŠ¡
        async function executeValidatorTask() {
            const citation = document.getElementById('citation-input').value;
            const format = document.getElementById('citation-format').value;

            if (!citation.trim()) {
                showError('validator-response', 'è¯·è¾“å…¥å¼•ç”¨ä¿¡æ¯');
                return;
            }

            showLoading('validator-loading');

            try {
                const response = await fetch('/api/v1/citations/validate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        citation: citation,
                        format: format
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('validator-response', 'å¼•ç”¨æ ¡éªŒå®Œæˆ', data);
                } else {
                    showError('validator-response', data.detail || 'æ ¡éªŒå¤±è´¥');
                }
            } catch (error) {
                showError('validator-response', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                hideLoading('validator-loading');
            }
        }

        // æ‰§è¡Œå®Œæ•´å·¥ä½œæµ
        async function executeWorkflow() {
            const keywords = document.getElementById('workflow-keywords').value;
            const limit = document.getElementById('workflow-limit').value;
            const analysisType = document.getElementById('workflow-analysis-type').value;
            const citationFormat = document.getElementById('workflow-citation-format').value;
            const generateReport = document.getElementById('workflow-generate-report').checked;

            if (!keywords.trim()) {
                showError('workflow-response', 'è¯·è¾“å…¥ç ”ç©¶å…³é”®è¯');
                return;
            }

            showLoading('workflow-loading');

            try {
                const response = await fetch('/api/v1/workflow/complete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        keywords: keywords,
                        limit: parseInt(limit),
                        analysis_type: analysisType,
                        citation_format: citationFormat,
                        writing_task: generateReport ? 'improve' : null
                    })
                });

                const data = await response.json();

                if (response.ok) {
                    showSuccess('workflow-response', 'ğŸ‰ å·¥ä½œæµæ‰§è¡Œå®Œæˆï¼', data);
                } else {
                    showError('workflow-response', data.detail || 'å·¥ä½œæµæ‰§è¡Œå¤±è´¥');
                }
            } catch (error) {
                showError('workflow-response', `ç½‘ç»œé”™è¯¯: ${error.message}`);
            } finally {
                hideLoading('workflow-loading');
            }
        }

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const uploadArea = document.getElementById('paper-upload-area');
            const fileInput = document.getElementById('paper-file');

            uploadArea.addEventListener('click', () => fileInput.click());

            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');

                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type === 'application/pdf') {
                    handleFileUpload(files[0]);
                }
            });

            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleFileUpload(e.target.files[0]);
                }
            });
        }

        // å¤„ç†æ–‡ä»¶ä¸Šä¼ 
        async function handleFileUpload(file) {
            const formData = new FormData();
            formData.append('file', file);

            showLoading('miner-loading');

            try {
                // ä½¿ç”¨æ–°çš„ PDF è§£æç«¯ç‚¹
                const response = await fetch('/api/v1/analysis/upload-pdf', {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();

                if (response.ok) {
                    // è‡ªåŠ¨å¡«å…… URL å­—æ®µ
                    document.getElementById('paper-url').value = data.file_path || '';

                    // æ˜¾ç¤ºè§£æç»“æœ
                    const uploadInfo = `
                        <div class="paper-card">
                            <h4>ğŸ“„ ${data.title || file.name}</h4>
                            <div class="authors">
                                ğŸ‘¥ ä½œè€…: ${data.authors ? data.authors.join(', ') : 'æœªçŸ¥'}
                            </div>
                            <div class="abstract">
                                ğŸ“ ${data.abstract || 'æ— æ‘˜è¦'}
                            </div>
                            <div class="meta">
                                <span>ğŸ“„ ${data.page_count || 0} é¡µ</span>
                                <span>ğŸ“Š ${data.word_count || 0} è¯</span>
                                <span>âœ… å·²è§£æ</span>
                            </div>
                        </div>
                    `;

                    showSuccess('miner-response', 'âœ… PDF æ–‡ä»¶ä¸Šä¼ å¹¶è§£ææˆåŠŸï¼ç°åœ¨å¯ä»¥é€‰æ‹©åˆ†æç±»å‹å¹¶å¼€å§‹åˆ†æã€‚', {
                        upload_info: uploadInfo
                    });
                } else {
                    showError('miner-response', data.detail || 'ä¸Šä¼ å¤±è´¥');
                }
            } catch (error) {
                showError('miner-response', `ä¸Šä¼ é”™è¯¯: ${error.message}`);
            } finally {
                hideLoading('miner-loading');
            }
        }

        // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        function showLoading(loadingId) {
            document.getElementById(loadingId).classList.add('active');
        }

        // éšè—åŠ è½½çŠ¶æ€
        function hideLoading(loadingId) {
            document.getElementById(loadingId).classList.remove('active');
        }

        // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
        function showSuccess(responseId, message, data = null) {
            const responseDiv = document.getElementById(responseId);

            let content = `<div class="success">âœ… ${message}</div>`;

            if (data) {
                // å·¥ä½œæµç»“æœ
                if (data.steps && Array.isArray(data.steps)) {
                    content += formatWorkflowResult(data);
                }
                // PDF ä¸Šä¼ ä¿¡æ¯
                else if (data.upload_info) {
                    content += data.upload_info;
                }
                // è®ºæ–‡æœç´¢ç»“æœ
                else if (data.papers && Array.isArray(data.papers)) {
                    content += formatPaperResults(data);
                }
                // è®ºæ–‡åˆ†æç»“æœ
                else if (data.analysis) {
                    content += formatAnalysisResult(data);
                }
                // å†™ä½œåŠ©æ‰‹ç»“æœ
                else if (data.result && typeof data.result === 'string') {
                    content += formatWritingResult(data);
                }
                // å¼•ç”¨æ ¡éªŒç»“æœ
                else if (data.formatted_citation) {
                    content += formatCitationResult(data);
                }
                // å…¶ä»–ç±»å‹çš„æ•°æ®ç”¨æ ¼å¼åŒ–çš„ JSON å±•ç¤º
                else {
                    const jsonStr = JSON.stringify(data, null, 2);
                    const jsonId = 'json-' + Date.now();
                    content += `
                        <div style="position: relative;">
                            <button class="copy-btn" onclick="copyToClipboard('${jsonId}', event)">ğŸ“‹ å¤åˆ¶</button>
                            <pre id="${jsonId}">${syntaxHighlight(jsonStr)}</pre>
                        </div>
                    `;
                }
            }

            responseDiv.innerHTML = content;
        }

        // æ ¼å¼åŒ–è®ºæ–‡æœç´¢ç»“æœ
        function formatPaperResults(data) {
            let html = `
                <div class="result-header">
                    <span>ğŸ“š æœç´¢ç»“æœ</span>
                    <span class="result-stats">å…±æ‰¾åˆ° ${data.papers.length} ç¯‡è®ºæ–‡</span>
                </div>
            `;

            data.papers.forEach((paper, index) => {
                html += `
                    <div class="paper-card">
                        <h4>${index + 1}. ${escapeHtml(paper.title)}</h4>
                        <div class="authors">
                            ğŸ‘¥ ä½œè€…: ${paper.authors.join(', ')}
                        </div>
                        <div class="abstract">
                            ğŸ“ ${escapeHtml(paper.abstract)}
                        </div>
                        <div class="meta">
                            <span>ğŸ“… ${paper.published_date}</span>
                            <span>ğŸ”— <a href="${paper.url}" target="_blank">æŸ¥çœ‹åŸæ–‡</a></span>
                            ${paper.pdf_url ? `<span>ğŸ“„ <a href="${paper.pdf_url}" target="_blank">ä¸‹è½½PDF</a></span>` : ''}
                            <span>ğŸ†” ${paper.id}</span>
                        </div>
                    </div>
                `;
            });

            return html;
        }

        // æ ¼å¼åŒ–è®ºæ–‡åˆ†æç»“æœ
        function formatAnalysisResult(data) {
            let html = `
                <div class="result-header">
                    <span>ğŸ§  è®ºæ–‡åˆ†æ</span>
                    <span class="result-stats">${data.analysis_type}</span>
                </div>
            `;

            if (data.paper_info) {
                html += `
                    <div class="paper-card">
                        <h4>${escapeHtml(data.paper_info.title)}</h4>
                        <div class="authors">
                            ğŸ‘¥ ä½œè€…: ${data.paper_info.authors.join(', ')}
                        </div>
                        <div class="meta">
                            <span>ğŸ“… ${data.paper_info.published_date}</span>
                            <span>ğŸ”— <a href="${data.paper_info.url}" target="_blank">æŸ¥çœ‹åŸæ–‡</a></span>
                            <span>ğŸ·ï¸ ${data.paper_info.categories.join(', ')}</span>
                        </div>
                    </div>
                `;
            }

            const analysisId = 'analysis-' + Date.now();
            html += '<div class="paper-card">';
            html += '<h4>ğŸ“Š åˆ†æç»“æœ <button class="copy-btn" onclick="copyToClipboard(\'' + analysisId + '\', event)" style="float: right;">ğŸ“‹ å¤åˆ¶</button></h4>';
            html += '<div class="markdown-content" id="' + analysisId + '">';
            html += renderMarkdown(data.analysis);
            html += '</div>';
            html += '</div>';

            return html;
        }

        // æ”¹è¿›çš„ Markdown æ¸²æŸ“å™¨
        function renderMarkdown(text) {
            if (!text) return '';

            // æŒ‰è¡Œå¤„ç†
            const lines = text.split('\n');
            let html = '';
            let inList = false;
            let listItems = [];

            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];

                // è·³è¿‡ç©ºè¡Œ
                if (!line.trim()) {
                    if (inList) {
                        html += '<ul style="list-style-type: disc; padding-left: 25px; margin: 15px 0;">' + listItems.join('') + '</ul>';
                        listItems = [];
                        inList = false;
                    }
                    html += '<br/>';
                    continue;
                }

                // æ ‡é¢˜ (å¿…é¡»åœ¨è¡Œé¦–) - ä»æœ€é•¿çš„å¼€å§‹åŒ¹é…
                const h4Match = line.match(/^####\s+(.+)$/);
                if (h4Match) {
                    if (inList) {
                        html += '<ul style="list-style-type: disc; padding-left: 25px; margin: 15px 0;">' + listItems.join('') + '</ul>';
                        listItems = [];
                        inList = false;
                    }
                    html += '<h4 style="color: #667eea; margin: 15px 0 8px 0; font-size: 1.05rem; font-weight: 600;">' + formatInlineMarkdown(h4Match[1]) + '</h4>';
                    continue;
                }

                const h3Match = line.match(/^###\s+(.+)$/);
                if (h3Match) {
                    if (inList) {
                        html += '<ul style="list-style-type: disc; padding-left: 25px; margin: 15px 0;">' + listItems.join('') + '</ul>';
                        listItems = [];
                        inList = false;
                    }
                    html += '<h3 style="color: #667eea; margin: 20px 0 10px 0; font-size: 1.1rem; font-weight: 600;">' + formatInlineMarkdown(h3Match[1]) + '</h3>';
                    continue;
                }

                const h2Match = line.match(/^##\s+(.+)$/);
                if (h2Match) {
                    if (inList) {
                        html += '<ul style="list-style-type: disc; padding-left: 25px; margin: 15px 0;">' + listItems.join('') + '</ul>';
                        listItems = [];
                        inList = false;
                    }
                    html += '<h2 style="color: #667eea; margin: 25px 0 15px 0; font-size: 1.3rem; font-weight: 600;">' + formatInlineMarkdown(h2Match[1]) + '</h2>';
                    continue;
                }

                const h1Match = line.match(/^#\s+(.+)$/);
                if (h1Match) {
                    if (inList) {
                        html += '<ul style="list-style-type: disc; padding-left: 25px; margin: 15px 0;">' + listItems.join('') + '</ul>';
                        listItems = [];
                        inList = false;
                    }
                    html += '<h1 style="color: #667eea; margin: 30px 0 20px 0; font-size: 1.5rem; font-weight: 600;">' + formatInlineMarkdown(h1Match[1]) + '</h1>';
                    continue;
                }

                // æœ‰åºåˆ—è¡¨
                const orderedMatch = line.match(/^(\d+)\.\s+(.+)$/);
                if (orderedMatch) {
                    const content = orderedMatch[2];
                    const formatted = formatInlineMarkdown(content);
                    listItems.push(`<li style="margin: 10px 0; line-height: 1.8;">${formatted}</li>`);
                    inList = true;
                    continue;
                }

                // æ— åºåˆ—è¡¨
                const unorderedMatch = line.match(/^[-*]\s+(.+)$/);
                if (unorderedMatch) {
                    const content = unorderedMatch[1];
                    const formatted = formatInlineMarkdown(content);
                    listItems.push(`<li style="margin: 10px 0; line-height: 1.8;">${formatted}</li>`);
                    inList = true;
                    continue;
                }

                // æ™®é€šæ®µè½
                if (inList) {
                    html += '<ul style="list-style-type: disc; padding-left: 25px; margin: 15px 0;">' + listItems.join('') + '</ul>';
                    listItems = [];
                    inList = false;
                }

                const formatted = formatInlineMarkdown(line);
                html += `<p style="margin: 12px 0; line-height: 1.8; color: #444;">${formatted}</p>`;
            }

            // å¤„ç†æœªé—­åˆçš„åˆ—è¡¨
            if (inList) {
                html += '<ul style="list-style-type: disc; padding-left: 25px; margin: 15px 0;">' + listItems.join('') + '</ul>';
            }

            return html;
        }

        // æ ¼å¼åŒ–è¡Œå†… Markdown å…ƒç´ 
        function formatInlineMarkdown(text) {
            // è½¬ä¹‰ HTML
            text = escapeHtml(text);

            // ç²—ä½“ **text**
            text = text.replace(/\*\*(.+?)\*\*/g, '<strong style="color: #333; font-weight: 600;">$1</strong>');

            // æ–œä½“ *text*
            text = text.replace(/\*(.+?)\*/g, '<em>$1</em>');

            // è¡Œå†…ä»£ç  `code`
            text = text.replace(/`([^`]+)`/g, '<code style="background: #f0f0f0; padding: 2px 6px; border-radius: 3px; font-family: monospace; color: #e83e8c; font-size: 0.9em;">$1</code>');

            // é“¾æ¥ [text](url)
            text = text.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" style="color: #667eea; text-decoration: none; border-bottom: 1px solid #667eea;">$1</a>');

            return text;
        }

        // æ ¼å¼åŒ–å†™ä½œåŠ©æ‰‹ç»“æœ
        function formatWritingResult(data) {
            let html = `
                <div class="result-header">
                    <span>âœï¸ å†™ä½œåŠ©æ‰‹</span>
                    <span class="result-stats">${data.task} - ${data.style}</span>
                </div>
            `;

            if (data.original) {
                html += `
                    <div class="paper-card">
                        <h4>ğŸ“ åŸæ–‡</h4>
                        <div class="abstract" style="background: #f8f9fa; padding: 15px; border-radius: 6px;">
                            ${escapeHtml(data.original)}
                        </div>
                    </div>
                `;
            }

            const resultId = 'writing-result-' + Date.now();
            html += '<div class="paper-card">';
            html += '<h4>âœ¨ å¤„ç†ç»“æœ <button class="copy-btn" onclick="copyToClipboard(\'' + resultId + '\', event)" style="float: right;">ğŸ“‹ å¤åˆ¶</button></h4>';
            html += '<div class="markdown-content" id="' + resultId + '">';
            html += renderMarkdown(data.result);
            html += '</div>';
            html += '</div>';

            return html;
        }

        // æ ¼å¼åŒ–å¼•ç”¨æ ¡éªŒç»“æœ
        function formatCitationResult(data) {

            const jsonId = 'citation-' + Date.now();
            let html = `
                <div class="result-header">
                    <span>ğŸ” å¼•ç”¨æ ¡éªŒ</span>
                    <span class="result-stats">${data.format.toUpperCase()} ${data.verified ? 'âœ… å·²éªŒè¯' : 'âš ï¸ æœªéªŒè¯'}</span>
                </div>
            `;

            if (data.metadata) {
                const meta = data.metadata;

                // å¤„ç†æ ‡é¢˜
                let title = 'N/A';
                if (meta.title) {
                    title = Array.isArray(meta.title) ? meta.title[0] : meta.title;
                }

                // å¤„ç†ä½œè€…
                let authors = 'N/A';
                if (meta.authors) {
                    if (Array.isArray(meta.authors)) {
                        authors = meta.authors.join(', ');
                    } else {
                        authors = meta.authors;
                    }
                }

                // å¤„ç†å¹´ä»½
                let year = 'N/A';
                if (meta.year) {
                    year = meta.year;
                } else if (meta.published && meta.published['date-parts']) {
                    year = meta.published['date-parts'][0][0];
                }

                // å¤„ç†æœŸåˆŠ
                let journal = 'N/A';
                if (meta.journal) {
                    journal = meta.journal;
                } else if (meta['container-title']) {
                    journal = Array.isArray(meta['container-title']) ? meta['container-title'][0] : meta['container-title'];
                }

                html += `
                    <div class="paper-card">
                        <h4>ğŸ“„ è®ºæ–‡ä¿¡æ¯</h4>
                        <div class="authors">
                            ğŸ“– æ ‡é¢˜: ${escapeHtml(title)}
                        </div>
                        <div class="authors">
                            ğŸ‘¥ ä½œè€…: ${escapeHtml(authors)}
                        </div>
                        <div class="meta">
                            <span>ğŸ“… ${year}</span>
                            <span>ğŸ“š ${escapeHtml(journal)}</span>
                            ${meta.arxiv_id ? `<span>ğŸ”— arXiv:${meta.arxiv_id}</span>` : ''}
                            ${meta.doi ? `<span>ğŸ”— DOI:${meta.doi}</span>` : ''}
                        </div>
                    </div>
                `;
            }

            html += `
                <div class="paper-card">
                    <h4>ğŸ“‹ æ ¼å¼åŒ–å¼•ç”¨ <button class="copy-btn" onclick="copyToClipboard('${jsonId}', event)" style="float: right;">ğŸ“‹ å¤åˆ¶</button></h4>
                    <pre id="${jsonId}" style="background: white; padding: 15px; border-radius: 6px; border-left: 4px solid #667eea; overflow-x: auto;">${escapeHtml(data.formatted_citation)}</pre>
                </div>
            `;

            if (data.warnings && data.warnings.length > 0) {
                html += `
                    <div class="error">
                        âš ï¸ ${data.warnings.join('; ')}
                    </div>
                `;
            }

            return html;
        }

        // æ ¼å¼åŒ–å·¥ä½œæµç»“æœ
        function formatWorkflowResult(data) {
            let html = `
                <div class="result-header">
                    <span>ğŸ”„ å·¥ä½œæµæ‰§è¡Œç»“æœ</span>
                    <span class="result-stats">${data.status === 'completed' ? 'âœ… å®Œæˆ' : 'âš ï¸ éƒ¨åˆ†å®Œæˆ'}</span>
                </div>
            `;

            // æ˜¾ç¤ºæ‘˜è¦
            if (data.summary) {
                html += `
                    <div class="paper-card">
                        <h4>ğŸ“Š æ‰§è¡Œæ‘˜è¦</h4>
                        <div class="meta">
                            <span>ğŸ“š æ‰¾åˆ° ${data.summary.total_papers} ç¯‡è®ºæ–‡</span>
                            <span>ğŸ§  åˆ†æ ${data.summary.analyzed_papers} ç¯‡</span>
                            <span>ğŸ“ ç”Ÿæˆ ${data.summary.generated_citations} æ¡å¼•ç”¨</span>
                        </div>
                        <p style="margin-top: 10px; color: #666;">å…³é”®è¯: ${data.summary.keywords}</p>
                    </div>
                `;
            }

            // æ˜¾ç¤ºå„æ­¥éª¤ç»“æœ
            if (data.steps && data.steps.length > 0) {
                data.steps.forEach((step, index) => {
                    const statusIcon = step.status === 'completed' ? 'âœ…' : step.status === 'failed' ? 'âŒ' : 'â³';

                    html += `
                        <div class="paper-card">
                            <h4>${statusIcon} æ­¥éª¤ ${step.step}: ${step.name}</h4>
                    `;

                    if (step.status === 'completed' && step.result) {
                        // è®ºæ–‡æœç´¢ç»“æœ
                        if (step.result.papers) {
                            html += `<p>æ‰¾åˆ° ${step.result.total_found} ç¯‡è®ºæ–‡</p>`;
                            step.result.papers.slice(0, 3).forEach((paper, i) => {
                                html += `
                                    <div style="margin: 10px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
                                        <strong>${i + 1}. ${escapeHtml(paper.title)}</strong><br>
                                        <small>ä½œè€…: ${paper.authors.slice(0, 3).join(', ')}${paper.authors.length > 3 ? ' et al.' : ''}</small>
                                    </div>
                                `;
                            });
                        }

                        // åˆ†æç»“æœ
                        if (step.result.analyses) {
                            html += `<p>å®Œæˆ ${step.result.total_analyzed} ç¯‡è®ºæ–‡åˆ†æ</p>`;
                            step.result.analyses.forEach((analysis, i) => {
                                html += `
                                    <div style="margin: 10px 0; padding: 10px; background: #f0f7ff; border-radius: 5px;">
                                        <strong>${i + 1}. ${escapeHtml(analysis.title)}</strong>
                                        <div class="markdown-content" style="margin-top: 10px;">
                                            ${renderMarkdown(analysis.analysis.substring(0, 500) + '...')}
                                        </div>
                                    </div>
                                `;
                            });
                        }

                        // å¼•ç”¨ç»“æœ
                        if (step.result.citations) {
                            html += `<p>ç”Ÿæˆ ${step.result.total_citations} æ¡å¼•ç”¨</p>`;
                            const citationId = 'citations-' + Date.now();
                            html += `<button class="copy-btn" onclick="copyToClipboard('${citationId}', event)">ğŸ“‹ å¤åˆ¶å…¨éƒ¨å¼•ç”¨</button>`;
                            html += `<div id="${citationId}" style="margin-top: 10px;">`;
                            step.result.citations.forEach((citation, i) => {
                                html += `<p style="margin: 5px 0;">${i + 1}. ${escapeHtml(citation.formatted_citation)}</p>`;
                            });
                            html += '</div>';
                        }

                        // æŠ¥å‘Šç»“æœ
                        if (step.result.report) {
                            const reportId = 'report-' + Date.now();
                            html += `<button class="copy-btn" onclick="copyToClipboard('${reportId}', event)">ğŸ“‹ å¤åˆ¶æŠ¥å‘Š</button>`;
                            html += `<div class="markdown-content" id="${reportId}" style="margin-top: 10px;">`;
                            html += renderMarkdown(step.result.report);
                            html += '</div>';
                        }
                    } else if (step.status === 'failed') {
                        html += `<p style="color: #f44336;">é”™è¯¯: ${step.error}</p>`;
                    }

                    html += '</div>';
                });
            }

            return html;
        }

        // HTML è½¬ä¹‰å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // JSON è¯­æ³•é«˜äº®
        function syntaxHighlight(json) {
            json = json.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
            return json.replace(/("(\\u[a-zA-Z0-9]{4}|\\[^u]|[^\\"])*"(\s*:)?|\b(true|false|null)\b|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?)/g, function (match) {
                let cls = 'json-number';
                if (/^"/.test(match)) {
                    if (/:$/.test(match)) {
                        cls = 'json-key';
                    } else {
                        cls = 'json-string';
                    }
                } else if (/true|false/.test(match)) {
                    cls = 'json-boolean';
                } else if (/null/.test(match)) {
                    cls = 'json-null';
                }
                return '<span class="' + cls + '">' + match + '</span>';
            });
        }

        // å¤åˆ¶åˆ°å‰ªè´´æ¿
        function copyToClipboard(elementId, event) {
            // é˜»æ­¢äº‹ä»¶å†’æ³¡
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }

            const element = document.getElementById(elementId);
            if (!element) {
                return;
            }

            // è·å–çº¯æ–‡æœ¬å†…å®¹
            const text = element.innerText || element.textContent;

            navigator.clipboard.writeText(text).then(() => {
                // æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º
                const btn = event ? event.target : null;
                if (btn) {
                    const originalText = btn.textContent;
                    btn.textContent = 'âœ… å·²å¤åˆ¶';
                    btn.style.background = '#4caf50';
                    btn.style.color = 'white';
                    btn.style.borderColor = '#4caf50';

                    setTimeout(() => {
                        btn.textContent = originalText;
                        btn.style.background = '';
                        btn.style.color = '';
                        btn.style.borderColor = '';
                    }, 2000);
                }
                console.log('å·²å¤åˆ¶ ' + text.length + ' ä¸ªå­—ç¬¦');
            }).catch(err => {
                console.error('å¤åˆ¶å¤±è´¥:', err);
                alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é€‰æ‹©æ–‡æœ¬å¤åˆ¶');
            });
        }

        // æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
        function showError(responseId, message) {
            const responseDiv = document.getElementById(responseId);
            responseDiv.innerHTML = `
                <div class="error">
                    âŒ ${message}
                </div>
            `;
        }
    </script>
</body>

</html>