"""
ç®€å•å¤šæ™ºèƒ½ä½“å¤©æ°”ç©¿è¡£å»ºè®®ç³»ç»Ÿ
æä¾›ç›´æ¥çš„åŸå¸‚è¾“å…¥åŠŸèƒ½ï¼Œä½¿ç”¨çœŸå®å¤©æ°”æ•°æ®ï¼Œç©¿è¡£å»ºè®®ç”±LLMå¤„ç†
"""
import sys
import os
import json
import random

def get_city_input():
    """è·å–ç”¨æˆ·è¾“å…¥çš„åŸå¸‚åç§°"""
    print("ğŸ’¬ æ¬¢è¿ä½¿ç”¨å¤šæ™ºèƒ½ä½“å¤©æ°”ç©¿è¡£å»ºè®®ç³»ç»Ÿï¼")
    print("ğŸ’¡ è¯·è¾“å…¥æ‚¨æƒ³æŸ¥è¯¢å¤©æ°”çš„åŸå¸‚åç§°")
    print("ğŸ’¡ æ”¯æŒä¸­æ–‡å’Œè‹±æ–‡åŸå¸‚å")
    print("ğŸ’¡ è¾“å…¥ 'quit' æˆ– 'é€€å‡º' å¯ä»¥é€€å‡ºç¨‹åº\n")
    
    while True:
        city = input("ğŸŒ è¯·è¾“å…¥åŸå¸‚åç§°: ").strip()
        if not city:
            print("âŒ è¯·è¾“å…¥æœ‰æ•ˆçš„åŸå¸‚åç§°")
            continue
            
        return city

def get_real_weather(city_name):
    """è·å–çœŸå®å¤©æ°”æ•°æ®"""
    try:
        # å¯¼å…¥Weatherç±»
        from weather import Weather
        
        # åˆ›å»ºå¤©æ°”æŸ¥è¯¢å®ä¾‹
        weather = Weather()
        
        # æŸ¥è¯¢å¤©æ°”ä¿¡æ¯
        weather_info = weather.get_weather(city_name)
        
        # è·å–è¯¦ç»†å¤©æ°”æ•°æ®ç”¨äºç©¿è¡£å»ºè®®
        weather_details = weather.get_weather_details(city_name)
        
        return weather_info, weather_details
        
    except Exception as e:
        print(f"âŒ å¤©æ°”æŸ¥è¯¢å¤±è´¥: {e}")
        # è¿”å›æ¨¡æ‹Ÿæ•°æ®ä½œä¸ºå¤‡ç”¨
        return f"ğŸ™ï¸ åŸå¸‚: {city_name}\nğŸŒ¡ï¸ æ¸©åº¦: 20Â°C\nğŸ“ å¤©æ°”: æ™´æœ—\nğŸ’§ æ¹¿åº¦: 50%\nğŸŒ¬ï¸ é£é€Ÿ: 3 m/s", None

def get_llm_fashion_advice(weather_details, city_name):
    """ä½¿ç”¨LLMåŸºäºçœŸå®å¤©æ°”æ•°æ®ç”Ÿæˆç©¿è¡£å»ºè®®"""
    if weather_details and "error" not in weather_details:
        # ä½¿ç”¨çœŸå®å¤©æ°”æ•°æ®
        temp = weather_details.get('temperature', 20)
        description = weather_details.get('description', 'æ™´æœ—')
        humidity = weather_details.get('humidity', 50)
        wind_speed = weather_details.get('wind_speed', 3)
        
        # æ„å»ºLLMæç¤ºè¯
        prompt = f"""
è¯·æ ¹æ®ä»¥ä¸‹å¤©æ°”ä¿¡æ¯ä¸º{city_name}æä¾›ä¸“ä¸šçš„ç©¿è¡£å»ºè®®ï¼š
- æ¸©åº¦: {temp}Â°C
- å¤©æ°”çŠ¶å†µ: {description}
- æ¹¿åº¦: {humidity}%
- é£é€Ÿ: {wind_speed} m/s

è¯·æä¾›è¯¦ç»†ã€å®ç”¨çš„ç©¿è¡£å»ºè®®ï¼ŒåŒ…æ‹¬ï¼š
1. ä¸Šè¡£é€‰æ‹©
2. ä¸‹è£…é€‰æ‹©  
3. é‹å­å»ºè®®
4. å¤–å¥—/é…é¥°
5. ç‰¹åˆ«æ³¨æ„äº‹é¡¹

è¯·ç”¨ä¸­æ–‡å›å¤ï¼Œæ ¼å¼è¦æ¸…æ™°æ˜“è¯»ã€‚"""
        
        # æ¨¡æ‹ŸLLMå“åº”ï¼ˆåœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œä¼šè°ƒç”¨çœŸå®çš„LLM APIï¼‰
        llm_response = simulate_llm_response(prompt, temp, description)
        
        return f"ğŸ¤– LLMæ™ºèƒ½ç©¿è¡£å»ºè®®ï¼ˆåŸºäº{city_name}çš„çœŸå®å¤©æ°”æ•°æ®ï¼‰ï¼š\n\n{llm_response}"
    else:
        # ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
        prompt = f"""
è¯·æ ¹æ®ä»¥ä¸‹å¤©æ°”ä¿¡æ¯ä¸º{city_name}æä¾›ä¸“ä¸šçš„ç©¿è¡£å»ºè®®ï¼š
- æ¸©åº¦: 20Â°C
- å¤©æ°”çŠ¶å†µ: æ™´æœ—
- æ¹¿åº¦: 50%
- é£é€Ÿ: 3 m/s

è¯·æä¾›è¯¦ç»†ã€å®ç”¨çš„ç©¿è¡£å»ºè®®ã€‚"""
        
        llm_response = simulate_llm_response(prompt, 20, 'æ™´æœ—')
        return f"ğŸ¤– LLMæ™ºèƒ½ç©¿è¡£å»ºè®®ï¼ˆåŸºäº{city_name}çš„å¤©æ°”æ•°æ®ï¼‰ï¼š\n\n{llm_response}"

def simulate_llm_response(prompt, temperature, weather_condition):
    """æ¨¡æ‹ŸLLMå“åº”ï¼Œæ ¹æ®æ¸©åº¦ç”Ÿæˆæ™ºèƒ½ç©¿è¡£å»ºè®®"""
    
    # åŸºäºæ¸©åº¦ç”Ÿæˆä¸åŒçš„å»ºè®®æ¨¡æ¿
    if temperature > 30:
        base_advice = {
            "ä¸Šè¡£": ["çŸ­è¢–Tæ¤", "é€æ°”è¡¬è¡«", "èƒŒå¿ƒ", "è½»è–„æè´¨ä¸Šè¡£"],
            "ä¸‹è£…": ["çŸ­è£¤", "è½»è–„é•¿è£¤", "é€æ°”æè´¨çš„è£¤å­"],
            "é‹å­": ["å‡‰é‹", "é€æ°”è¿åŠ¨é‹", "å¸†å¸ƒé‹"],
            "å¤–å¥—": ["é˜²æ™’è¡£", "è½»è–„å¤–å¥—å¤‡ç”¨"],
            "é…é¥°": ["å¤ªé˜³é•œ", "é®é˜³å¸½", "é˜²æ™’éœœ"],
            "å»ºè®®": "é€‰æ‹©æµ…è‰²ã€é€æ°”çš„é¢æ–™ï¼Œæ³¨æ„é˜²æ™’å’Œè¡¥æ°´"
        }
    elif temperature > 25:
        base_advice = {
            "ä¸Šè¡£": ["çŸ­è¢–Tæ¤", "è½»è–„é•¿è¢–", "é€æ°”è¡¬è¡«"],
            "ä¸‹è£…": ["ä¼‘é—²è£¤", "ç‰›ä»”è£¤", "è½»è–„æè´¨çš„è£¤å­"],
            "é‹å­": ["è¿åŠ¨é‹", "ä¼‘é—²é‹", "å¸†å¸ƒé‹"],
            "å¤–å¥—": ["è–„å¤–å¥—å¤‡ç”¨", "é˜²é£è¡£"],
            "é…é¥°": ["å¸½å­", "å¤ªé˜³é•œ"],
            "å»ºè®®": "å¯åˆ†å±‚ç©¿ç€ï¼Œä¾¿äºæ ¹æ®æ¸©åº¦å˜åŒ–è°ƒæ•´"
        }
    elif temperature > 20:
        base_advice = {
            "ä¸Šè¡£": ["é•¿è¢–Tæ¤", "è–„æ¬¾å«è¡£", "è¡¬è¡«"],
            "ä¸‹è£…": ["ä¼‘é—²è£¤", "ç‰›ä»”è£¤", "å¡å…¶è£¤"],
            "é‹å­": ["ä¼‘é—²é‹", "è¿åŠ¨é‹", "çš®é‹"],
            "å¤–å¥—": ["å¤¹å…‹", "è–„å¤–å¥—", "é£è¡£"],
            "é…é¥°": ["å›´å·¾å¤‡ç”¨", "å¸½å­"],
            "å»ºè®®": "æ¸©åº¦é€‚å®œï¼Œé€‚åˆæˆ·å¤–æ´»åŠ¨"
        }
    elif temperature > 15:
        base_advice = {
            "ä¸Šè¡£": ["é•¿è¢–è¡¬è¡«", "è–„æ¯›è¡£", "å«è¡£"],
            "ä¸‹è£…": ["é•¿è£¤", "ç‰›ä»”è£¤", "ä¼‘é—²è£¤"],
            "é‹å­": ["è¿åŠ¨é‹", "çš®é‹", "ä¼‘é—²é‹"],
            "å¤–å¥—": ["å¤¹å…‹", "é£è¡£", "è–„å¤–å¥—"],
            "é…é¥°": ["å›´å·¾", "å¸½å­"],
            "å»ºè®®": "æ³¨æ„ä¿æš–ï¼Œå¯æ­é…è–„å¤–å¥—"
        }
    elif temperature > 10:
        base_advice = {
            "ä¸Šè¡£": ["æ¯›è¡£", "åšè¡¬è¡«", "ä¿æš–å†…è¡£"],
            "ä¸‹è£…": ["åšè£¤å­", "ç‰›ä»”è£¤", "ä¿æš–è£¤"],
            "é‹å­": ["è¿åŠ¨é‹", "çš®é‹", "ä¿æš–é‹"],
            "å¤–å¥—": ["å¤¹å…‹", "é£è¡£", "è–„ç¾½ç»’æœ"],
            "é…é¥°": ["å›´å·¾", "æ‰‹å¥—", "å¸½å­"],
            "å»ºè®®": "æ³¨æ„ä¿æš–ï¼Œå¯æ­é…å›´å·¾"
        }
    else:
        base_advice = {
            "ä¸Šè¡£": ["ä¿æš–å†…è¡£", "åšæ¯›è¡£", "ç¾½ç»’å†…èƒ†"],
            "ä¸‹è£…": ["åšè£¤å­", "ä¿æš–è£¤", "ç¾½ç»’è£¤"],
            "é‹å­": ["ä¿æš–é´å­", "é›ªåœ°é´", "é˜²æ°´é‹"],
            "å¤–å¥—": ["ç¾½ç»’æœ", "åšå¤–å¥—", "é˜²é£è¡£"],
            "é…é¥°": ["å›´å·¾", "æ‰‹å¥—", "å¸½å­", "è€³ç½©"],
            "å»ºè®®": "å¤šå±‚ç©¿ç€ï¼Œæ³¨æ„é˜²å¯’ä¿æš–"
        }
    
    # æ ¹æ®å¤©æ°”çŠ¶å†µè°ƒæ•´å»ºè®®
    weather_adjustments = {
        "é›¨": {
            "é‹å­": ["é›¨é´", "é˜²æ°´é‹"],
            "é…é¥°": ["é›¨ä¼", "é›¨è¡£"],
            "å»ºè®®": "é€‰æ‹©é˜²æ°´é¢æ–™ï¼Œæ³¨æ„é˜²æ»‘"
        },
        "é›ª": {
            "é‹å­": ["é˜²æ»‘é´", "é›ªåœ°é´"],
            "é…é¥°": ["æ‰‹å¥—", "å¸½å­", "å›´å·¾"],
            "å»ºè®®": "æ³¨æ„é˜²æ»‘ä¿æš–ï¼Œé€‰æ‹©é˜²æ°´æè´¨"
        },
        "é£": {
            "å¤–å¥—": ["é˜²é£è¡£", "é£è¡£"],
            "é…é¥°": ["å¸½å­", "å›´å·¾"],
            "å»ºè®®": "é€‰æ‹©é˜²é£é¢æ–™ï¼Œæ³¨æ„ä¿æš–"
        }
    }
    
    # åº”ç”¨å¤©æ°”è°ƒæ•´
    for weather_key, adjustment in weather_adjustments.items():
        if weather_key in weather_condition:
            for category, items in adjustment.items():
                if category in base_advice:
                    if category == "å»ºè®®":
                        base_advice[category] += f"ï¼Œ{items}"
                    else:
                        base_advice[category].extend(items)
    
    # æ„å»ºå“åº”æ–‡æœ¬
    response = f"åŸºäºå½“å‰å¤©æ°”çŠ¶å†µï¼ˆ{temperature}Â°Cï¼Œ{weather_condition}ï¼‰ï¼Œä¸ºæ‚¨æä¾›ä»¥ä¸‹ç©¿è¡£å»ºè®®ï¼š\n\n"
    
    response += f"ğŸ‘• **ä¸Šè¡£é€‰æ‹©**: {', '.join(base_advice['ä¸Šè¡£'][:3])}\n"
    response += f"ğŸ‘– **ä¸‹è£…é€‰æ‹©**: {', '.join(base_advice['ä¸‹è£…'][:3])}\n"
    response += f"ğŸ‘Ÿ **é‹å­å»ºè®®**: {', '.join(base_advice['é‹å­'][:3])}\n"
    response += f"ğŸ§¥ **å¤–å¥—é…é¥°**: {', '.join(base_advice['å¤–å¥—'][:2])}"
    
    if base_advice['é…é¥°']:
        response += f"ï¼Œé…é¥°: {', '.join(base_advice['é…é¥°'][:3])}\n"
    else:
        response += "\n"
    
    response += f"ğŸ’¡ **ç‰¹åˆ«å»ºè®®**: {base_advice['å»ºè®®']}\n"
    
    # æ·»åŠ ä¸ªæ€§åŒ–å»ºè®®
    if temperature > 25:
        response += "ğŸŒ **æ¸©é¦¨æç¤º**: å¤©æ°”è¾ƒçƒ­ï¼Œå»ºè®®é€‰æ‹©é€æ°”æè´¨ï¼Œæ³¨æ„é˜²æ™’è¡¥æ°´"
    elif temperature < 10:
        response += "â„ï¸ **æ¸©é¦¨æç¤º**: å¤©æ°”è¾ƒå†·ï¼Œå»ºè®®å¤šå±‚ç©¿ç€ï¼Œæ³¨æ„ä¿æš–é˜²å¯’"
    else:
        response += "ğŸŒ¤ï¸ **æ¸©é¦¨æç¤º**: å¤©æ°”èˆ’é€‚ï¼Œé€‚åˆå„ç§æˆ·å¤–æ´»åŠ¨"
    
    return response

def main():
    """ä¸»å‡½æ•°"""
    try:
        # è·å–åŸå¸‚è¾“å…¥
        city = get_city_input()
        
        print(f"\nğŸ” æ­£åœ¨æŸ¥è¯¢ {city} çš„çœŸå®å¤©æ°”ä¿¡æ¯...")
        
        # è·å–çœŸå®å¤©æ°”æ•°æ®
        weather_info, weather_details = get_real_weather(city)
        
        # ç”Ÿæˆç©¿è¡£å»ºè®®ï¼ˆä½¿ç”¨LLMå¤„ç†ï¼‰
        print("ğŸ¤– æ­£åœ¨ä½¿ç”¨LLMç”Ÿæˆæ™ºèƒ½ç©¿è¡£å»ºè®®...")
        fashion_advice = get_llm_fashion_advice(weather_details, city)
        
        # æ˜¾ç¤ºç»“æœ
        print("\n" + "="*50)
        print("ğŸ“Š å¤©æ°”ä¿¡æ¯")
        print("="*50)
        print(weather_info)
        
        print("\n" + "="*50)
        print("ğŸ‘— ç©¿è¡£å»ºè®®")
        print("="*50)
        print(fashion_advice)
        
        print("\n" + "="*50)
        
        # è¯¢é—®æ˜¯å¦ç»§ç»­æŸ¥è¯¢
        while True:
            continue_query = input("\nğŸ” æ˜¯å¦ç»§ç»­æŸ¥è¯¢å…¶ä»–åŸå¸‚ï¼Ÿ(y/n): ").strip().lower()
            
            if continue_query in ['y', 'yes', 'æ˜¯', 'ç»§ç»­']:
                print("\n" + "-"*50)
                # é€’å½’è°ƒç”¨ä¸»å‡½æ•°ç»§ç»­æŸ¥è¯¢
                main()
                return
            elif continue_query in ['n', 'no', 'å¦', 'é€€å‡º']:
                print("ğŸ‘‹ æ„Ÿè°¢ä½¿ç”¨ï¼Œå†è§ï¼")
                return
            else:
                print("âŒ è¯·è¾“å…¥ y/æ˜¯ æˆ– n/å¦")
                
    except KeyboardInterrupt:
        print("\n\nğŸ‘‹ ç”¨æˆ·ä¸­æ–­ï¼Œç¨‹åºé€€å‡º")
        sys.exit(0)
    except Exception as e:
        print(f"\nâŒ å‘ç”Ÿé”™è¯¯: {e}")
        print("ğŸ’¡ è¯·ç¨åé‡è¯•")
        sys.exit(1)


if __name__ == "__main__":
    main()